/*
錄音
https://github.com/xiangyuecn/Recorder
src: extensions/create-audio.nmn2pcm.js
*/
!function(){var e="object"==typeof window&&!!window.document,t=(e?window:Object).Recorder,r=t.i18n;!function(e,t,r){"use strict";var n=function(t){var n=t.texts||[];"string"==typeof n&&(n=[n]);var i=t.sampleRate,o=i;(!o||o<1)&&(o=48e3);var l=t.meterDuration||600,s=t.timbre||2;s<1&&(s=1);var u=t.volume;null==u&&(u=.3),u=Math.max(0,u),u=Math.min(1,u);var h=t.waveType||"";-1==",sine,square,sawtooth,triangle,".indexOf(","+h+",")&&(h=""),h=h||"sine";var f=t.muteDuration;(null==f||f<0)&&(f=l/4)>50&&(f=50);var m=new Int16Array(o*f/1e3),_=t.beginDuration;(null==_||_<0)&&(_=200);var v=new Int16Array(o*_/1e3),g=t.endDuration;(null==g||g<0)&&(g=200);for(var w=new Int16Array(o*g/1e3),p=function(e){return 440/Math.pow(2,e/12)},c=[p(9),p(7),p(5),p(4),p(2),p(0),p(-2)],b={},M=1;M<=7;M++){var x=c[M-1];b[M+"..."]=x/8,b[M+".."]=x/4,b[M+"."]=x/2,b[M]=x,b[M+"'"]=2*x,b[M+"''"]=4*x,b[M+"'''"]=8*x}for(var y=[],D=0,d=9e4,R=0;-1!=i&&R<n.length;R++){for(var A=n[R].split(/[\s\|]+/),I=[],C=0,E=h,z=s,T=u,q=0;q<A.length;q++){var F=A[q];if(F){var N=F.charCodeAt(0);if(N<48||N>55){var G=(/^(\w)(?:\((.+)\)|\[(.+)\])*$/.exec(F)||[])[1],H=(/\((.+)\)/.exec(F)||[])[1],O=(/\[(.+)\]/.exec(F)||[])[1];if("R"==G?(E=h,z=s,T=u):"S"==G?E="sine":"Q"==G?E="square":"A"==G?E="sawtooth":"T"==G?E="triangle":G="",!G||H&&!+H||O&&!+O)throw new Error("Invalid: "+F);H&&(z=+H),O&&(T=u*O)}else{for(var P=F.split(","),j=l,B=0,L=0,Q=0,S=0;S<P.length;S++){var $=P[S].split(""),J={y:$[0],b:1,t:E,tb:z,vol:T};P[S]=J;for(var U=1;U<$.length;U++){if("'"==(x=$[U]))J.y+="'";else if("."==x)J.y+=".";else if("-"==x)J.b+=1,j+=l;else if("_"==x)J.b/=2,L=1;else{if("*"!=x||Q)throw new Error(r("3RBa::符号[{1}]无效：{2}",0,x,F));J.b+=.5,Q=.5,"*"==$[U+1]&&(J.b-=.25,Q=.25,U++)}}B+=J.b}B%1>0&&(L?j*=B/Math.ceil(B):Q&&(j+=l*Q)),j-=P.length*f;for(S=0;S<P.length;S++){E=(J=P[S]).t,z=J.tb,T=J.vol;var W=b[J.y]||0;if(!W&&"0"!=J.y)throw new Error(r("U212::音符[{1}]无效：{2}",0,J.y,F));W*=z;var Y=j*J.b/B,Z=new Int16Array(Math.round(Y/1e3*o));if(W){if(D=Math.max(D,W),d=Math.min(d,W),"sine"==E){var k=2*Math.PI*W/o;for(M=0;M<Z.length;M++){x=T*Math.sin(k*M);Z[M]=32767*Math.max(-1,Math.min(1,x))}}else if("square"==E)for(k=o/W,M=0;M<Z.length;M++){x=T*(M%k<k/2?1:-1);Z[M]=32767*Math.max(-1,Math.min(1,x))}else if("sawtooth"==E)for(k=o/W,M=0;M<Z.length;M++){x=T*(M%k*2/k-1);Z[M]=32767*Math.max(-1,Math.min(1,x))}else if("triangle"==E)for(k=o/W,M=0;M<Z.length;M++){var K=(M+k/4)%k;x=T*(K<k/2?4*K/k-1:3-4*K/k);Z[M]=32767*Math.max(-1,Math.min(1,x))}var V=~~(Z.length/o*1e3/4)||1;a(Z,o,Math.min(V,10))}var X=m;I.length||(X=v),I.push(X),C+=X.length,I.push(Z),C+=Z.length}}}}C>0&&(I.push(w),C+=w.length,y.push({buffers:I,size:C}))}y.sort(function(e,t){return t.size-e.size});for(Z=new Int16Array(y[0]&&y[0].size||0),R=0;R<y.length;R++){I=(J=y[R]).buffers,C=J.size;if(0==R){M=0;for(var ee=0;M<I.length;M++){var te=I[M];Z.set(te,ee),ee+=te.length}}else{var re=(Z.length-C)/o*1e3;if(re>10)throw new Error(r("7qAD::多个音时必须对齐，相差{1}ms",0,re));for(M=0,ee=0;M<I.length;M++){te=I[M];for(var ne=0;ne<te.length;ne++){var ae,ie=Z[ee],oe=te[ne];ae=ie<0&&oe<0?ie+oe-ie*oe/-32767:ie+oe-ie*oe/32767,Z[ee++]=ae}}}}Y=Math.round(Z.length/o*1e3);var le=[],se=~~(2*D);if(D&&o<se){var ue="sampleRate["+o+"] should be greater than "+se;le.push(ue),e.CLog("NMN2PCM: "+ue,3)}return{pcm:Z,duration:Y,warns:le,set:{texts:n,sampleRate:o,timbre:s,meterDuration:l,muteDuration:f,beginDuration:_,endDuration:g,volume:u,waveType:h}}},a=n.FadeInOut=function(e,t,r){for(var n=t/1e3*(r||1),a=0;a<n;a++)e[a]*=a/n;var i=e.length;for(a=~~(i-n);a<i;a++)e[a]*=(i-a)/n};n.GetExamples=function(){return{DFH:{name:"东方红",get:function(e){return n({sampleRate:e,meterDuration:1e3,timbre:3,texts:"5 5,6|2-|1 1,6.|2-|5 5|6,1' 6,5|1 1,6.|2-"})}},HappyBirthday:{name:r("QGsW::祝你生日快乐"),get:function(e){return n({sampleRate:e,meterDuration:450,timbre:4,waveType:"triangle",volume:.15,texts:"5.,5. 6. 5.|1 7.-|5.,5. 6. 5.|2 1-|5.,5. 5 3|1 7. 6.|4*,4_ 3 1|2 1-"})}},LHC:{name:"兰花草（洒水版）",get:function(e){return n({sampleRate:e,meterDuration:650,timbre:4,texts:"6.,3 3,3|3* 2_|1*,2_ 1,7.|6.-|6,6 6,6|6* 5_|3_,5_,5 5,4|3-|3,3_,6_ 6,5|3* 2_|1*,2_ 1,7.|6. 3.|3.,1 1,7.|6.* 2__,3__|2*,1_ 7._,7._,5.|6.-"})}},ForElise:{name:r("emJR::致爱丽丝"),get:function(e){return n({sampleRate:e,meterDuration:550,muteDuration:20,timbre:6,texts:"3',2'|3',2' 3',7 2',1'|6 0,1 3,6|7 0,3 5,7|1' 0 3',2'|3',2' 3',7 2',1'|6 0,1 3,6|7 0,3 1',7|6 0,7 1',2'|3' 0,5 4',3'|2' 0,4 3',2'|1' 0,3 2',1'|7"})}},Canon_Right:{name:r("GsYy::卡农-右手简谱"),get:function(e){return n({sampleRate:e,meterDuration:700,texts:"1',7 1',3 5 6,7|1' 3' 5',3' 5',6'|4',3' 2',4' 3',2' 1',7|      7 1',2'|5',3'_,4'_ 5',3'_,4'_ 5',5,6,7 1',2',3',4'|3',1'_,2'_ 3',3_,4_ 5,6,5,4 5,1',7,1'|6,1'_,7_ 6,5_,4_ 5,4,3,4 5,6,7,1'|6,1'_,7_ 1',7_,6_ 7,6,7,1' 2'_,1'_,7|1'-"})}},Canon:{name:r("bSFZ::卡农"),get:function(e){var t="",r="",a="",i="";return t+="3'---|2'---|1'---|7---|",r+="1'---|7---|6---|5---|",a+="5---|5---|3---|3---|",i+="R[0.3] 1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|",t+="6---|5---|6---|7---|",r+="4---|3---|4---|5---|",a+="1---|1---|1---|2---|",i+="4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|",t+="3'---|2'---|1'---|7---|",r+="1'---|7---|6---|5---|",a+="5---|5---|3---|3-- 5'|",i+="1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|",t+="4' 3' 2' 4'|3' 2' 1' 5|6- 6 1'|7 1' 2'-|",r+="4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5.. 2. 5. 7.|",a+="0---|0---|0---|0---|",i+="0---|0---|0---|0---|",t+="3',5 1'_ 5' 5_ 3'|3' 4' 3' 2'|1',3 6_ 3' 3_ 1'|1' 2' 1' 7|",r+="1. 5. 1 3|5.. 2. 5. 7.|6.. 3. 6. 1|3.. 7.. 3. 5.|",a+="0---|0---|0---|0---|",i+="0---|0---|0---|0---|",n({sampleRate:e,meterDuration:500,texts:[t+="6,1 4_ 1' 1_ 6|5,1 3_ 1' 1_ 5|6,1 4_ 1' 1_ 6|7 7 1' 2'|",r+="4.. 1. 4. 6.|1. 5. 1 3|4.. 1. 4. 6.|5..,5. 5..,5. 6..,6. 6..,6.|",a+="0---|0---|0---|0---|",i+="0---|0---|0---|0---|"]})}}}},e.NMN2PCM=n}(t,0,r.$T)}();